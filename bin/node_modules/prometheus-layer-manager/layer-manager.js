var simpleargs = require("simpleargs");
var Modules = require("prometheus-module-manager");

var LayerManager = new function(){

	this.mode = null;
	var stateLocal = null;
	var l_argument = null;
	var layerName = null;
	var isValid = null;

	this.isLocal = function(){
		return stateLocal;
	}

	this.getLayer = function(){
		return layerName;
	}
	this.isValid = function(){
		return isValid;
	}

	this.init = function(){
		this.mode = l_argument || "local";
		if(this.isLocal()){
			for(var i in layers){
				layers[i].init();
			}
			Modules.execute_modules(["services", "channels"]);
		}else{
			switch(this.getLayer()){
				case "db":
				db_layer.init();
				break;
				case "biz":
				biz_layer.init();
				Modules.execute_modules(["services"]);
				break;
				case "web":
				web_layer.init();
				Modules.execute_modules(["channels"]);
				break;
			}
		}

		return false;
	}

	var checkLocal = function(){
		l_argument = simpleargs(process.argv.slice(2))["l"];
		stateLocal = l_argument==="local" || l_argument===null || l_argument==undefined;
	}
	var checkLayer = function(){
		if(!l_argument){
			layerName =  null;
		}else{
			layerName = l_argument;
		}
	}
	var checkValidation = function(){
		if(process.argv.length > 3) {
			var arg = process.argv[3];
			if(typeof(arg) === 'undefined' || arg === null || (arg!="web" && arg!="biz" && arg != "db")) {
				isValid = false;
			}

		}
		isValid = true;
	}

	checkLocal();
	checkLayer();
	checkValidation();
}

module.exports = LayerManager;

var web_layer = require("prometheus-web-layer");
var biz_layer = require("prometheus-business-layer");
var db_layer = require("prometheus-database-layer");

var layers = {
	"db": db_layer,
	"web": web_layer,
	"biz": biz_layer,
}