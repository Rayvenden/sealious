var DatabaseAccess = require("prometheus-database-accessor");
var metadata = require('prometheus-metadata-manager');
var ResourceTypeManager = require("prometheus-resource-type-manager");

var resource_manager = new function(){

	this.newResource = function(type_name, value, callback){
		ResourceTypeManager.enforce_correct_type_name(type_name);

		var resource_type_object = ResourceTypeManager.getByName(type_name);
		resource_type_object.validateFieldValues(value);
		
		metadata.increment("first_free_id", function(newID) {
			DatabaseAccess.query("resources", "insert", {prometheus_id: newID, type: type_name, body: value }, {}).then(function(data){
				callback(data);
			});
		});
	}

	this.getResourceByID = function(resource_id, callback){
		DatabaseAccess.query("resources", "find", { _id: resource_id }, {}).then(function(response){
			callback(response);
		})
	}

	this.getResourceByType = function(type_name, params, callback) {
		ResourceTypeManager.enforce_correct_type_name(type_name);
		type_name = type_name.toString();
		DatabaseAccess.query("resources", "find", { type: type_name }, {}, params).then(function(response) {
			callback(response);
		})
	}
}

module.exports = resource_manager;